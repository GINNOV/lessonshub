import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Check, X, Trophy, Heart, Star, Film, Volume2, ArrowRight, Home, Info } from 'lucide-react';

/**
 * MOCK DATA - "THE CINEMA API"
 * In a real production app, this would be fetched from a backend.
 * We include it here to ensure the app is fully functional and "dynamic" out of the box.
 */
const MOVIE_DATABASE = [
  // --- PRINCIPIANTE (BEGINNER) ---
  {
    id: 1,
    title: "Toy Story",
    genre: "Animation",
    difficulty: "beginner",
    videoId: "KYz2wyBy3kc", // Toy Story "You are a toy" scene
    startSeconds: 50,
    endSeconds: 56,
    transcript: "You are a ______! You aren't the real Buzz Lightyear!",
    hiddenWord: "toy",
    translation: "Sei un giocattolo! Non sei il vero Buzz Lightyear!",
    quiz: {
      question: "Why is Woody angry?",
      options: [
        "Buzz is eating his food",
        "Buzz thinks he is a real space ranger",
        "Buzz broke his arm",
        "Buzz is sleeping"
      ],
      answer: 1
    }
  },
  {
    id: 2,
    title: "Finding Nemo",
    genre: "Animation",
    difficulty: "beginner",
    videoId: "2zLkasScy7A", // Dory speaking whale
    startSeconds: 50,
    endSeconds: 55,
    transcript: "You can't ______ whale!",
    hiddenWord: "speak",
    translation: "Non sai parlare il balenese!",
    quiz: {
      question: "What is Dory trying to do?",
      options: [
        "Swim fast",
        "Eat fish",
        "Communicate with a whale",
        "Sleep"
      ],
      answer: 2
    }
  },
  {
    id: 3,
    title: "The Lion King",
    genre: "Animation",
    difficulty: "beginner",
    videoId: "GibiNy4d4gc", // Circle of Life intro or dialogue
    startSeconds: 42,
    endSeconds: 47,
    transcript: "Everything the light touches is our ______.",
    hiddenWord: "kingdom",
    translation: "Tutto ciÃ² che Ã¨ illuminato dal sole Ã¨ il nostro regno.",
    quiz: {
      question: "What is Mufasa showing Simba?",
      options: [
        "The dark shadow",
        "Their kingdom",
        "A river",
        "The stars"
      ],
      answer: 1
    }
  },

  // --- INTERMEDIO (INTERMEDIATE) ---
  {
    id: 4,
    title: "Harry Potter",
    genre: "Fantasy",
    difficulty: "intermediate",
    videoId: "VyHV0BRtdxo", // Wingardium Leviosa
    startSeconds: 22,
    endSeconds: 29,
    transcript: "Stop, stop, stop! You're going to take someone's ______ out.",
    hiddenWord: "eye",
    translation: "Ferma, ferma, ferma! Finirai per cavare l'occhio a qualcuno.",
    quiz: {
      question: "How does Hermione feel about Ron's spell casting?",
      options: [
        "She is impressed",
        "She is annoyed and worried",
        "She doesn't care",
        "She is asleep"
      ],
      answer: 1
    }
  },
  {
    id: 5,
    title: "Spider-Man",
    genre: "Action",
    difficulty: "intermediate",
    videoId: "tPq4Fm9gT8I", // Great power great responsibility
    startSeconds: 30,
    endSeconds: 36,
    transcript: "With great power comes great ______.",
    hiddenWord: "responsibility",
    translation: "Da un grande potere derivano grandi responsabilitÃ .",
    quiz: {
      question: "What is Uncle Ben teaching Peter?",
      options: [
        "How to fight",
        "How to make money",
        "A moral lesson",
        "How to drive"
      ],
      answer: 2
    }
  },
  {
    id: 6,
    title: "Forrest Gump",
    genre: "Drama",
    difficulty: "intermediate",
    videoId: "VhMFo8Ad8kE", // Box of chocolates
    startSeconds: 15,
    endSeconds: 22,
    transcript: "My momma always said, life was like a ______ of chocolates.",
    hiddenWord: "box",
    translation: "Mamma diceva sempre: la vita Ã¨ come una scatola di cioccolatini.",
    quiz: {
      question: "What does the metaphor mean?",
      options: [
        "Life is sweet",
        "Life is unpredictable",
        "Life is expensive",
        "Life is short"
      ],
      answer: 1
    }
  },

  // --- AVANZATO (ADVANCED) ---
  {
    id: 7,
    title: "The Social Network",
    genre: "Drama",
    difficulty: "advanced",
    videoId: "2SBV660i874", // Lawyer scene
    startSeconds: 5,
    endSeconds: 12,
    transcript: "You don't get to ______ who I look at!",
    hiddenWord: "decide",
    translation: "Non sta a te decidere chi devo guardare!",
    quiz: {
      question: "What is the tone of the conversation?",
      options: [
        "Friendly and casual",
        "Hostile and intense",
        "Boring and slow",
        "Funny and joking"
      ],
      answer: 1
    }
  },
  {
    id: 8,
    title: "Pulp Fiction",
    genre: "Crime",
    difficulty: "advanced",
    videoId: "x2qRDMHbXaM", // Royale with cheese
    startSeconds: 45,
    endSeconds: 52,
    transcript: "They don't call it a Quarter Pounder with ______?",
    hiddenWord: "cheese",
    translation: "Non lo chiamano un quarto di libbra con formaggio?",
    quiz: {
      question: "What are they discussing?",
      options: [
        "Differences in metric systems",
        "The price of food",
        "How to cook burgers",
        "A robbery plan"
      ],
      answer: 0
    }
  },
];

// --- COMPONENTS ---

const DifficultyBadge = ({ level }) => {
  const colors = {
    beginner: "bg-green-100 text-green-800 border-green-200",
    intermediate: "bg-yellow-100 text-yellow-800 border-yellow-200",
    advanced: "bg-red-100 text-red-800 border-red-200"
  };
  const labels = {
    beginner: "Principiante",
    intermediate: "Intermedio",
    advanced: "Avanzato"
  };
  return (
    <span className={`px-2 py-1 rounded-full text-xs font-semibold border ${colors[level]}`}>
      {labels[level]}
    </span>
  );
};

export default function CineLingua() {
  // App State
  const [currentView, setCurrentView] = useState('home'); // home, levels, game, summary
  const [selectedDifficulty, setSelectedDifficulty] = useState(null);
  const [currentClip, setCurrentClip] = useState(null);
  const [score, setScore] = useState(0);
  const [lives, setLives] = useState(3);
  const [completedClips, setCompletedClips] = useState([]);

  // Game State
  const [isPlaying, setIsPlaying] = useState(false);
  const [inputValue, setInputValue] = useState('');
  const [feedback, setFeedback] = useState(null); // 'correct', 'incorrect'
  const [showQuiz, setShowQuiz] = useState(false);
  const [quizFeedback, setQuizFeedback] = useState(null);
  const playerRef = useRef(null);
  const intervalRef = useRef(null);

  // Filter movies based on difficulty
  const filteredMovies = selectedDifficulty
    ? MOVIE_DATABASE.filter(m => m.difficulty === selectedDifficulty)
    : [];

  const handleStartGame = (difficulty) => {
    setSelectedDifficulty(difficulty);
    setCurrentView('levels');
  };

  const handleSelectClip = (clip) => {
    setCurrentClip(clip);
    setCurrentView('game');
    setInputValue('');
    setFeedback(null);
    setShowQuiz(false);
    setQuizFeedback(null);
    setIsPlaying(false);
  };

  const handleReturnHome = () => {
    setCurrentView('home');
    setLives(3);
    setScore(0);
    setCompletedClips([]);
  };

  // --- YOUTUBE PLAYER LOGIC ---

  // This effect loads the YouTube IFrame API
  useEffect(() => {
    if (!window.YT) {
      const tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
  }, []);

  // Initialize player when entering game view
  useEffect(() => {
    if (currentView === 'game' && currentClip) {
      // Small delay to ensure container exists
      setTimeout(() => {
        if (window.YT && window.YT.Player) {
          createPlayer();
        } else {
          window.onYouTubeIframeAPIReady = createPlayer;
        }
      }, 100);
    }
    return () => clearInterval(intervalRef.current);
  }, [currentView, currentClip]);

  const createPlayer = () => {
    if (playerRef.current) {
      playerRef.current.destroy();
    }
    playerRef.current = new window.YT.Player('youtube-player', {
      height: '100%',
      width: '100%',
      videoId: currentClip.videoId,
      playerVars: {
        'playsinline': 1,
        'controls': 0, // Hide default controls for game feel
        'modestbranding': 1,
        'rel': 0,
        'start': currentClip.startSeconds,
        'end': currentClip.endSeconds + 1 // Buffer
      },
      events: {
        'onStateChange': onPlayerStateChange
      }
    });
  };

  const onPlayerStateChange = (event) => {
    // 1 = Playing, 2 = Paused
    if (event.data === 1) {
      setIsPlaying(true);
      startLoopMonitor();
    } else {
      setIsPlaying(false);
      stopLoopMonitor();
    }
  };

  const startLoopMonitor = () => {
    stopLoopMonitor();
    intervalRef.current = setInterval(() => {
      if (playerRef.current && playerRef.current.getCurrentTime) {
        const currentTime = playerRef.current.getCurrentTime();
        if (currentTime >= currentClip.endSeconds) {
          playerRef.current.pauseVideo();
          playerRef.current.seekTo(currentClip.startSeconds);
        }
      }
    }, 100);
  };

  const stopLoopMonitor = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
    }
  };

  const togglePlay = () => {
    if (playerRef.current && playerRef.current.getPlayerState) {
      if (isPlaying) {
        playerRef.current.pauseVideo();
      } else {
        playerRef.current.seekTo(currentClip.startSeconds);
        playerRef.current.playVideo();
      }
    }
  };

  // --- GAME LOGIC ---

  const checkWord = () => {
    const cleanInput = inputValue.trim().toLowerCase();
    const cleanTarget = currentClip.hiddenWord.toLowerCase();

    if (cleanInput === cleanTarget) {
      setFeedback('correct');
      setScore(score + 100);
      // Play success sound logic here if needed
    } else {
      setFeedback('incorrect');
      setLives(lives - 1);
    }
  };

  const checkQuiz = (optionIndex) => {
    if (optionIndex === currentClip.quiz.answer) {
      setQuizFeedback('correct');
      setScore(score + 50);
      setCompletedClips([...completedClips, currentClip.id]);
    } else {
      setQuizFeedback('incorrect');
      setLives(lives - 1);
    }
  };

  const nextClip = () => {
    // Find next uncompleted clip or go back to list
    setCurrentView('levels');
  };

  // --- VIEWS ---

  if (lives <= 0) {
    return (
      <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center p-4 font-sans">
        <div className="bg-slate-800 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center border border-slate-700">
          <div className="text-6xl mb-4">ðŸ˜¢</div>
          <h2 className="text-3xl font-bold mb-2 text-red-400">Game Over</h2>
          <p className="text-slate-400 mb-6">Hai finito le vite! Ma non preoccuparti, l'inglese richiede pratica.</p>
          <div className="text-2xl font-mono mb-8">Punteggio: {score}</div>
          <button
            onClick={handleReturnHome}
            className="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-semibold transition-colors"
          >
            Riprova (Try Again)
          </button>
        </div>
      </div>
    );
  }

  // HOME VIEW
  if (currentView === 'home') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-900 to-slate-900 text-white font-sans">
        <div className="container mx-auto px-4 py-12 flex flex-col items-center">
          <div className="mb-8 p-4 bg-white/10 rounded-full">
            <Film size={48} className="text-blue-400" />
          </div>
          <h1 className="text-5xl font-extrabold mb-4 text-center tracking-tight">
            Cine<span className="text-blue-400">Lingua</span>
          </h1>
          <p className="text-xl text-slate-300 mb-12 text-center max-w-lg">
            Impara l'inglese attraverso i film. <br/>
            <span className="text-sm text-slate-400 opacity-75">Guarda la scena, riempi gli spazi, rispondi alle domande.</span>
          </p>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl">
            {[
              { id: 'beginner', label: 'Principiante', sub: 'Easy & Slow', icon: <Star size={24} />, color: 'bg-green-600 hover:bg-green-500' },
              { id: 'intermediate', label: 'Intermedio', sub: 'Standard English', icon: <Play size={24} />, color: 'bg-yellow-600 hover:bg-yellow-500' },
              { id: 'advanced', label: 'Avanzato', sub: 'Fast & Slang', icon: <Trophy size={24} />, color: 'bg-red-600 hover:bg-red-500' }
            ].map((level) => (
              <button
                key={level.id}
                onClick={() => handleStartGame(level.id)}
                className={`${level.color} p-6 rounded-xl transition-all transform hover:scale-105 shadow-lg flex flex-col items-center justify-center gap-3 border border-white/10`}
              >
                <div className="bg-white/20 p-3 rounded-full">{level.icon}</div>
                <div className="text-xl font-bold">{level.label}</div>
                <div className="text-xs uppercase tracking-wider opacity-80">{level.sub}</div>
              </button>
            ))}
          </div>

          <div className="mt-16 text-slate-500 text-sm">
             Contenuti offerti via YouTube â€¢ Free Education
          </div>
        </div>
      </div>
    );
  }

  // CLIP SELECTION VIEW
  if (currentView === 'levels') {
    return (
      <div className="min-h-screen bg-slate-50 text-slate-900 font-sans">
        {/* Header */}
        <div className="bg-white border-b sticky top-0 z-10 shadow-sm">
          <div className="container mx-auto px-4 py-4 flex items-center justify-between">
            <button onClick={() => setCurrentView('home')} className="p-2 hover:bg-slate-100 rounded-full transition-colors">
              <Home size={20} className="text-slate-600" />
            </button>
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-1 bg-red-50 text-red-600 px-3 py-1 rounded-full">
                <Heart size={16} fill="currentColor" />
                <span className="font-bold">{lives}</span>
              </div>
              <div className="flex items-center gap-1 bg-blue-50 text-blue-600 px-3 py-1 rounded-full">
                <Trophy size={16} />
                <span className="font-bold">{score}</span>
              </div>
            </div>
          </div>
        </div>

        <div className="container mx-auto px-4 py-8">
          <div className="mb-6">
            <h2 className="text-2xl font-bold text-slate-800">Scegli una scena</h2>
            <p className="text-slate-500">Livello: {selectedDifficulty === 'beginner' ? 'Principiante' : selectedDifficulty === 'intermediate' ? 'Intermedio' : 'Avanzato'}</p>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {filteredMovies.map(movie => {
              const isCompleted = completedClips.includes(movie.id);
              return (
                <button
                  key={movie.id}
                  onClick={() => handleSelectClip(movie)}
                  disabled={isCompleted}
                  className={`group relative bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden text-left transition-all ${isCompleted ? 'opacity-60 cursor-default' : 'hover:shadow-md hover:border-blue-400'}`}
                >
                  {/* Thumbnail Mockup using YouTube Image */}
                  <div className="aspect-video bg-slate-200 relative overflow-hidden">
                    <img
                      src={`https://img.youtube.com/vi/${movie.videoId}/mqdefault.jpg`}
                      alt={movie.title}
                      className="w-full h-full object-cover transition-transform group-hover:scale-110"
                    />
                    {isCompleted && (
                      <div className="absolute inset-0 bg-green-500/80 flex items-center justify-center">
                        <Check size={40} className="text-white" />
                      </div>
                    )}
                    {!isCompleted && (
                      <div className="absolute inset-0 bg-black/30 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <Play fill="white" className="text-white" size={40} />
                      </div>
                    )}
                  </div>

                  <div className="p-4">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="font-bold text-lg text-slate-800 leading-tight">{movie.title}</h3>
                      <DifficultyBadge level={movie.difficulty} />
                    </div>
                    <p className="text-sm text-slate-500">{movie.genre}</p>
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  // GAME VIEW
  if (currentView === 'game' && currentClip) {
    const parts = currentClip.transcript.split('______');

    return (
      <div className="min-h-screen bg-slate-900 text-white flex flex-col md:flex-row h-screen overflow-hidden">

        {/* Left Side: Player */}
        <div className="w-full md:w-2/3 bg-black relative flex items-center justify-center">
          <div className="absolute top-4 left-4 z-20">
             <button onClick={() => setCurrentView('levels')} className="bg-black/50 hover:bg-black/70 p-2 rounded-full text-white backdrop-blur-sm">
                <ArrowRight className="rotate-180" size={24} />
             </button>
          </div>

          <div className="aspect-video w-full max-w-5xl shadow-2xl bg-black">
             <div id="youtube-player" className="w-full h-full"></div>
          </div>

          {/* Custom Controls */}
          <div className="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4 z-20 bg-slate-800/80 backdrop-blur-md px-6 py-3 rounded-full border border-white/10 shadow-lg">
             <button onClick={togglePlay} className="hover:text-blue-400 transition-colors">
               {isPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" />}
             </button>
             <button onClick={() => { playerRef.current.seekTo(currentClip.startSeconds); playerRef.current.playVideo(); }} className="hover:text-blue-400 transition-colors">
               <RotateCcw size={28} />
             </button>
             <div className="w-px h-8 bg-white/20"></div>
             <span className="text-xs font-mono opacity-70">
               {isPlaying ? "ASCOLTA..." : "PREMI PLAY"}
             </span>
          </div>
        </div>

        {/* Right Side: Interactive Area */}
        <div className="w-full md:w-1/3 bg-slate-50 text-slate-900 flex flex-col border-l border-slate-200 overflow-y-auto">
          {/* Header Stats */}
          <div className="p-6 border-b bg-white flex justify-between items-center shadow-sm">
             <div>
               <h2 className="font-bold text-xl">{currentClip.title}</h2>
               <p className="text-xs text-slate-500 uppercase tracking-wide">English Learning</p>
             </div>
             <div className="flex gap-3">
               <div className="flex flex-col items-center">
                  <Heart size={20} className="text-red-500" fill="currentColor" />
                  <span className="text-xs font-bold">{lives}</span>
               </div>
               <div className="flex flex-col items-center">
                  <Trophy size={20} className="text-blue-500" />
                  <span className="text-xs font-bold">{score}</span>
               </div>
             </div>
          </div>

          {/* Step 1: Fill in the blank */}
          <div className={`p-8 transition-all duration-500 ${showQuiz ? 'opacity-50 pointer-events-none blur-[2px]' : ''}`}>
             <div className="flex items-center gap-2 mb-4 text-blue-600">
               <Volume2 size={20} />
               <span className="font-bold text-sm uppercase">Step 1: Listening</span>
             </div>

             <div className="mb-6 text-xl leading-relaxed text-slate-700 font-medium bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
               {parts[0]}
               <span className={`inline-block border-b-2 mx-1 px-1 transition-colors ${feedback === 'correct' ? 'border-green-500 text-green-700 bg-green-50' : 'border-blue-400'}`}>
                 {feedback === 'correct' ? currentClip.hiddenWord : '______'}
               </span>
               {parts[1]}
             </div>

             {feedback !== 'correct' ? (
               <div className="flex gap-2">
                 <input
                   type="text"
                   value={inputValue}
                   onChange={(e) => setInputValue(e.target.value)}
                   onKeyDown={(e) => e.key === 'Enter' && checkWord()}
                   placeholder="Type the missing word..."
                   className="flex-1 px-4 py-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                   autoComplete="off"
                 />
                 <button
                   onClick={checkWord}
                   className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg shadow-blue-200 transition-all active:scale-95"
                 >
                   Check
                 </button>
               </div>
             ) : (
               <div className="bg-green-100 border border-green-200 text-green-800 p-4 rounded-lg flex items-center justify-between animate-fade-in">
                 <div className="flex items-center gap-2">
                   <Check size={20} />
                   <span className="font-bold">Ottimo! (Great!)</span>
                 </div>
                 <button
                   onClick={() => setShowQuiz(true)}
                   className="text-sm bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 font-semibold"
                 >
                   Next Step &rarr;
                 </button>
               </div>
             )}

             {feedback === 'incorrect' && (
               <p className="mt-3 text-red-500 text-sm flex items-center gap-1 animate-pulse">
                 <X size={16} /> Riprova! Ascolta attentamente.
               </p>
             )}

             <div className="mt-8 p-4 bg-slate-100 rounded-lg text-sm text-slate-500">
               <p className="font-semibold text-slate-700 mb-1">Traduzione:</p>
               {currentClip.translation}
             </div>
          </div>

          {/* Step 2: Comprehension Quiz */}
          {showQuiz && (
            <div className="p-8 border-t border-slate-200 bg-white flex-1 animate-slide-up">
               <div className="flex items-center gap-2 mb-4 text-purple-600">
                 <Info size={20} />
                 <span className="font-bold text-sm uppercase">Step 2: Comprehension</span>
               </div>

               <h3 className="text-lg font-bold mb-6 text-slate-800">{currentClip.quiz.question}</h3>

               <div className="space-y-3">
                 {currentClip.quiz.options.map((option, idx) => {
                   let btnClass = "w-full text-left p-4 rounded-lg border border-slate-200 hover:bg-slate-50 transition-colors";
                   if (quizFeedback === 'correct' && idx === currentClip.quiz.answer) {
                     btnClass = "w-full text-left p-4 rounded-lg border border-green-300 bg-green-100 text-green-800 font-bold";
                   } else if (quizFeedback === 'incorrect' && idx !== currentClip.quiz.answer) {
                      btnClass = "w-full text-left p-4 rounded-lg border border-slate-200 opacity-50"; // Dim others
                   }

                   return (
                     <button
                       key={idx}
                       onClick={() => !quizFeedback && checkQuiz(idx)}
                       className={btnClass}
                       disabled={!!quizFeedback}
                     >
                       {option}
                     </button>
                   );
                 })}
               </div>

               {quizFeedback === 'correct' && (
                 <div className="mt-6 flex justify-end">
                   <button
                     onClick={nextClip}
                     className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-slate-700 transition-all flex items-center gap-2"
                   >
                     Torna ai Livelli <ArrowRight size={18} />
                   </button>
                 </div>
               )}
               {quizFeedback === 'incorrect' && (
                  <p className="mt-4 text-center text-red-500 font-semibold">Risposta sbagliata. Hai perso una vita!</p>
               )}
            </div>
          )}
        </div>
      </div>
    );
  }

  return null;
}
